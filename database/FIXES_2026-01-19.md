# Database Fixes - January 19, 2026

## Overview

This document describes the critical database fixes applied to resolve backend authentication and dashboard loading issues.

## Issues Fixed

### 1. SQL Ambiguity Error in `get_user_context` Function

**Severity**: Critical  
**Impact**: All authenticated API calls were failing with 401 Unauthorized

#### Problem
The `get_user_context` function had a parameter naming conflict that caused PostgreSQL to throw an ambiguity error:

```
ERROR: 42702: column reference "user_id" is ambiguous
DETAIL: It could refer to either a PL/pgSQL variable or a table column.
```

This prevented the `TenantContextGuard` from retrieving user tenant information, blocking all protected API endpoints.

#### Solution
Fixed the function by using qualified parameter references (`get_user_context.user_id`) instead of bare parameter names.

**Migration File**: `14_fix_user_context_function.sql`

#### Verification
```sql
-- Test with actual user ID
SELECT * FROM get_user_context('93e982a9-f55a-41db-a24b-4928bac15835');

-- Expected output:
-- tenant_id: 10000000-0000-0000-0000-000000000001
-- role_names: ["COMPANY_ADMIN"]
-- is_platform_admin: false
```

### 2. Missing `dashboard:read` Permission

**Severity**: High  
**Impact**: Dashboard endpoint returned 403 Forbidden even with valid authentication

#### Problem
The backend dashboard controller required `dashboard:read` permission, but only `dashboard:view` existed in the database.

#### Solution
- Created the `dashboard:read` permission
- Assigned it to the `COMPANY_ADMIN` role

**Migration File**: `14_fix_user_context_function.sql`

#### Verification
```sql
-- Check permission exists
SELECT * FROM public.permissions 
WHERE module = 'dashboard' AND action = 'read';

-- Check COMPANY_ADMIN has the permission
SELECT r.name as role_name, p.module, p.action, p.resource
FROM public.role_permissions rp
JOIN public.roles r ON rp.role_id = r.id
JOIN public.permissions p ON rp.permission_id = p.id
WHERE r.name = 'COMPANY_ADMIN' AND p.module = 'dashboard';
```

## Additional Setup (Manual)

The following were set up manually for the demo environment:

### Admin User Setup
```sql
-- Insert admin user (if not exists)
INSERT INTO public.users (id, tenant_id, email, first_name_en, last_name_en, status, language) 
VALUES (
  '93e982a9-f55a-41db-a24b-4928bac15835', 
  '10000000-0000-0000-0000-000000000001', 
  'admin@admin.com', 
  'Admin', 
  'User', 
  'active', 
  'en'
) ON CONFLICT (id) DO UPDATE 
SET tenant_id = EXCLUDED.tenant_id, 
    email = EXCLUDED.email, 
    status = EXCLUDED.status;

-- Assign COMPANY_ADMIN role
INSERT INTO public.user_roles (user_id, tenant_id, role_id) 
VALUES (
  '93e982a9-f55a-41db-a24b-4928bac15835', 
  '10000000-0000-0000-0000-000000000001', 
  'a21b0ab7-8726-49b4-a60b-59952a1452d1'
) ON CONFLICT DO NOTHING;
```

## Testing

### 1. Test Authentication
```bash
curl -X POST https://accounting-saas-production-bd32.up.railway.app/api/auth/sign-in \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@admin.com","password":"123456"}'
```

Expected: Returns session with access_token

### 2. Test Dashboard Access
```bash
# Get token from sign-in response
TOKEN="<access_token_from_above>"

curl https://accounting-saas-production-bd32.up.railway.app/api/dashboard \
  -H "Authorization: Bearer $TOKEN"
```

Expected: Returns dashboard data (may be empty if no transactions exist)

## Migration Application

To apply these fixes to a new environment:

```bash
# Using psql
psql -h <host> -U <user> -d <database> -f database/14_fix_user_context_function.sql

# Or using Supabase SQL Editor
# Copy and paste the contents of 14_fix_user_context_function.sql
```

## Impact Assessment

### Before Fixes
- ❌ All authenticated API calls failed with 401
- ❌ Dashboard returned 403 Forbidden
- ❌ Users could not access any protected endpoints
- ❌ Frontend stuck on "Loading..." screen

### After Fixes
- ✅ Authentication works correctly
- ✅ Dashboard endpoint accepts authenticated requests
- ✅ User context properly retrieved
- ✅ Permissions correctly enforced

## Related Files

- **Migration**: `database/14_fix_user_context_function.sql`
- **Backend Guard**: `backend/src/common/guards/tenant-context.guard.ts`
- **Supabase Service**: `backend/src/supabase/supabase.service.ts`
- **Dashboard Controller**: `backend/src/dashboard/dashboard.controller.ts`

## Notes

- All fixes were applied at the database level
- No backend or frontend code changes required
- The function fix is backward compatible
- Existing users are not affected by the permission addition

## Rollback

If needed, the previous version of the function can be restored, but it will reintroduce the ambiguity error. Not recommended.

## Future Improvements

1. Add automated tests for database functions
2. Implement function parameter naming conventions to avoid conflicts
3. Create a permission seeding script for consistency across environments
4. Add database migration version tracking
